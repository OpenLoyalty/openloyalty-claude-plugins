---
description: Code review following Open Loyalty conventions and senior engineer practices
globs:
  - "**/*.php"
  - "**/*.ts"
  - "**/*.tsx"
alwaysApply: false
---

# Open Loyalty Code Review

When asked to "review this code", "check against OL standards", or review changes:

## Step 1: Identify Changes & Ticket

```bash
# Get branch name (extract OLOY-XXX ticket ID)
git rev-parse --abbrev-ref HEAD

# List changed files
git diff main...HEAD --name-only

# Get diff statistics
git diff main...HEAD --stat
```

## Step 2: Load Context

**AGENTS.md:** Read for conventions and rules.

**Jira Ticket (if ID found):** Fetch via MCP to understand requirements:
- What should the code implement?
- Acceptance criteria to verify

## Step 3: Review by File Type

### PHP/Backend Files

Check AGENTS.md rules:
- **DEV020**: CQRS patterns
- **DEV022**: Event handling
- **DEV027**: Value objects
- **DEV034**: Dependency injection

Look for:
- N+1 queries (loops calling repositories, missing eager loading)
- Missing type hints/return types
- SQL injection vulnerabilities

### TypeScript/Frontend Files

Check AGENTS.md rules:
- **TS001**: Prefer `const` over `let`
- **TS002**: Explicit types
- **COMP002**: Component structure
- **FORM001**: Form handling

## Step 4: Test Quality Review

**Don't just check if tests exist - evaluate quality:**

- Are edge cases tested?
- **Snapshot concern**: Do tests check full responses or just specific fields?
  - `assertEquals($response['id'], 1)` won't catch new/removed fields
  - Recommend full response assertions
- Missing test cases for new code?
- Would tests catch exploratory testing bugs?

## Step 5: Performance Review

- **N+1 queries**: Loops with repository calls, missing `->with()` / JOIN FETCH
- Large collections without pagination
- Missing indexes for new queries

## Step 6: Migration Review

If migrations present:
- Valid for MySQL AND PostgreSQL?
- Safe rollback?
- Recommend local testing against main branch DB

## Step 7: Ticket Compliance

If Jira context available:
- Does code implement all acceptance criteria?
- Any requirements missing?
- Scope creep (unrelated changes)?

## Step 8: Calculate Score (1-10)

| Score | Meaning |
|-------|---------|
| 10 | Exceptional - exemplary code, full ticket compliance |
| 8-9 | Excellent - no critical issues, minor suggestions |
| 6-7 | Good - no critical issues, some important issues |
| 4-5 | Needs Work - critical issues or many important issues |
| 1-3 | Poor - multiple critical issues, do not merge |

Adjustments: +1 excellent tests, +1 ticket compliance, -1 N+1 queries, -1 missing tests, -2 weak test assertions

## Step 9: Categorize Findings

**Critical (Must Fix):**
- Security vulnerabilities
- AGENTS.md critical rule violations
- Code doesn't match ticket requirements
- N+1 queries on listings

**Important (Should Fix):**
- Convention violations
- Missing tests
- Tests with weak assertions
- Partial ticket implementation

**Suggestions:**
- Style improvements
- Snapshot testing recommendations

## Step 10: Format Review

```markdown
# Code Review: {branch_name}

**Date:** {YYYY-MM-DD}
**Ticket:** {OLOY-XXX} - {summary}
**Files Changed:** {count}
**Score:** {N}/10 {"████████░░" visual}

**Verdict:** {APPROVED / CHANGES_REQUESTED}

## Ticket Compliance

| Requirement | Status |
|-------------|--------|
| {req} | ✅/⚠️/❌ |

## Critical Issues

{List or "None found"}

### {Issue title}
- **File:** `{path}:{line}`
- **Rule:** {AGENTS.md reference}
- **Problem:** {description}
- **Fix:** {suggestion}

## Important Issues

{List issues}

## Test Quality

- {Concerns about test assertions}
- {Missing test cases}

## Performance Notes

{N+1 queries, etc.}

## Exploratory Testing Recommendations

1. {Specific scenario to test manually}
2. {Edge case}
3. Compare API response: GET /api/xxx between main and branch

## Checklist

- [ ] AGENTS.md rules followed
- [ ] Code implements ticket requirements
- [ ] Tests with meaningful assertions
- [ ] No N+1 queries
- [ ] Migrations tested locally
```

## Step 11: Offer Next Steps

Ask if the engineer wants:
1. More detail on specific issues
2. Code suggestions for fixes
3. To proceed (if no critical issues)
4. Tips to improve the score
5. Detailed exploratory test scenarios
